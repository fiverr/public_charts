suite: test nodepool - nodes-workers
templates:
  - nodepool.yaml

values:
  - values.yaml

tests:
  - it: Verify nodes-workers metadata
    documentIndex: 1
    asserts:
      - isKind:
          of: NodePool
      - equal:
          path: metadata.name
          value: nodes-workers-arm64
      - equal:
          path: spec.template.metadata.labels.cluster
          value: eks-dev
      - equal:
          path: spec.template.metadata.labels.nodegroup
          value: nodes-workers
      - isNull:
          path: spec.template.metadata.labels.testlabel1
      - equal:
          path: spec.template.spec.nodeClassRef.name
          value: nodes-workers-arm64
      - equal:
          path: spec.template.spec.startupTaints[0].key
          value: testtaint1
      - equal:
          path: spec.template.spec.startupTaints[0].value
          value: taint1
      - equal:
          path: spec.template.spec.startupTaints[0].effect
          value: noSchedule
      - equal:
          path: spec.template.spec.startupTaints[1].key
          value: testtaint2
      - equal:
          path: spec.template.spec.startupTaints[1].value
          value: taint2
      - equal:
          path: spec.template.spec.startupTaints[1].effect
          value: noSchedule

  - it: Verify nodes-workers requirements
    documentIndex: 1
    asserts:
    # instance-category
      - notContains:
          path: spec.template.spec.requirements[0].values
          content: m
      - equal:
          path: spec.template.spec.requirements[0].values[0]
          value: t
      - equal:
          path: spec.template.spec.requirements[0].values[1]
          value: x
    # instance-cpu
      - equal:
          path: spec.template.spec.requirements[1].values[0]
          value: "2"
      - equal:
          path: spec.template.spec.requirements[1].values[1]
          value: "6"
    # instance-generation
      - equal:
          path: spec.template.spec.requirements[2].operator
          value: "Gt"
      - equal:
          path: spec.template.spec.requirements[2].values[0]
          value: "4"
    # instance-zone
      - equal:
          path: spec.template.spec.requirements[3].values[0]
          value: "eu-west-1g"
    # instance-architecture
      - equal:
          path: spec.template.spec.requirements[4].values[0]
          value: "arm64"
    # instance-capacity-type
      - equal:
          path: spec.template.spec.requirements[5].values[0]
          value: "on-demand"
    # instance-OS
      - equal:
          path: spec.template.spec.requirements[6].values[0]
          value: "linux"
    # instance-family Exclusions
      - equal:
          path: spec.template.spec.requirements[7].values[0]
          value: "m6a"
    # instance-size Exclusiong
      - equal:
          path: spec.template.spec.requirements[8].operator
          value: NotIn
      - equal:
          path: spec.template.spec.requirements[8].values[0]
          value: metal

  - it: Verify nodes-workers kubelet
    documentIndex: 1
    asserts:
      - equal:
          path: spec.template.spec.kubelet.systemReserved.cpu
          value: 750m
      - equal:
          path: spec.template.spec.kubelet.kubeReserved.ephemeral-storage
          value: 4Gi
      - equal:
          path: spec.template.spec.kubelet.clusterDNS[0]
          value: "1.1.1.1"
      - equal:
          path: spec.template.spec.kubelet.clusterDNS[1]
          value: "2.2.2.2"

  - it: Verify nodes-workers Options
    documentIndex: 1
    asserts:
      - equal:
          path: spec.disruption.expireAfter
          value: 720h
      - equal:
          path: spec.disruption.consolidationPolicy
          value: WhenEmpty
      - equal:
          path: spec.disruption.consolidateAfter
          value: 10m
      - isNull:
          path: spec.budgets
      - equal:
          path: spec.limits.cpu
          value: 100
      - equal:
          path: spec.limits.memory
          value: "384Gi"
      - equal:
          path: spec.weight
          value: 3

